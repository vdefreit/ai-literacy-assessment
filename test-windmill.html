<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Windmill Connection Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
        }
        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }
        input, textarea {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        button {
            background: #0263e0;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 10px;
        }
        button:hover {
            background: #0052cc;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .success {
            background: #e8f7ed;
            border: 1px solid #14b053;
            color: #0d5c2e;
        }
        .error {
            background: #fdecea;
            border: 1px solid #d61f1f;
            color: #891111;
        }
        .info {
            background: #e1f0ff;
            border: 1px solid #0263e0;
            color: #003d99;
        }
        .loading {
            color: #666;
            font-style: italic;
        }
        label {
            display: block;
            font-weight: 600;
            margin-top: 15px;
            color: #333;
        }
        .help-text {
            font-size: 13px;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîó Windmill Connection Tester</h1>
        <p class="subtitle">Test your Windmill backend before deploying to GitHub Pages</p>

        <label for="endpoint">Windmill Webhook URL</label>
        <input 
            type="text" 
            id="endpoint" 
            value="https://twilio.windmill.dev/api/w/td/jobs/run_wait_result/p/u/VinceDeFreitas/openai_key__2__"
        >
        <p class="help-text">Get this from your Windmill script settings (Webhook/Public API)</p>

        <label for="testMessage">Test Message</label>
        <textarea 
            id="testMessage" 
            rows="3" 
            placeholder="Hello! Can you help me test this connection?"
        >Hello! Can you help me test this connection?</textarea>
        <p class="help-text">This message will be sent to the OpenAI API via Windmill</p>

        <button onclick="testConnection()">Test Connection</button>

        <div id="result"></div>
    </div>

    <script>
        // Auto-fill endpoint if config.js exists
        if (typeof CONFIG !== 'undefined' && CONFIG.WINDMILL_ENDPOINT !== 'YOUR_WINDMILL_WEBHOOK_URL_HERE') {
            document.getElementById('endpoint').value = CONFIG.WINDMILL_ENDPOINT;
        }

        async function testConnection() {
            const endpoint = document.getElementById('endpoint').value;
            const testMessage = document.getElementById('testMessage').value;
            const resultDiv = document.getElementById('result');
            const button = document.querySelector('button');

            // Validation
            if (!endpoint) {
                resultDiv.className = 'result error';
                resultDiv.textContent = '‚ùå Please enter a Windmill webhook URL';
                return;
            }

            if (!testMessage) {
                resultDiv.className = 'result error';
                resultDiv.textContent = '‚ùå Please enter a test message';
                return;
            }

            // Show loading
            button.disabled = true;
            resultDiv.className = 'result loading';
            resultDiv.textContent = '‚è≥ Sending request to Windmill...';

            try {
                const startTime = Date.now();

                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer UQG324s2K6fXMmQQRgQpYAtZSDAzzxU5'
                    },
                    body: JSON.stringify({
                        messages: [
                            {
                                role: 'system',
                                content: 'You are a helpful assistant. Respond briefly to confirm the connection is working.'
                            },
                            {
                                role: 'user',
                                content: testMessage
                            }
                        ],
                        model: 'gpt-4o',
                        max_tokens: 150,
                        temperature: 0.7
                    })
                });

                const duration = Date.now() - startTime;

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const data = await response.json();

                // Handle different response formats
                let aiResponse;
                let usage;

                if (data.success && data.content) {
                    // Custom proxy format
                    aiResponse = data.content;
                    usage = data.usage;
                } else if (data.choices && data.choices[0]) {
                    // OpenAI native format
                    aiResponse = data.choices[0].message.content;
                    usage = data.usage;
                } else {
                    throw new Error('Unexpected response format: ' + JSON.stringify(data));
                }

                // Show success
                resultDiv.className = 'result success';
                resultDiv.innerHTML = `
‚úÖ <strong>Connection Successful!</strong>

<strong>Response time:</strong> ${duration}ms

<strong>AI Response:</strong>
${aiResponse}

<strong>Token Usage:</strong>
${usage ? `- Prompt: ${usage.prompt_tokens} tokens
- Completion: ${usage.completion_tokens} tokens
- Total: ${usage.total_tokens} tokens` : 'Not available'}

<strong>‚ú® Your Windmill backend is working correctly!</strong>
You can now deploy to GitHub Pages.
                `.trim();

            } catch (error) {
                console.error('Connection error:', error);
                
                resultDiv.className = 'result error';
                resultDiv.innerHTML = `
‚ùå <strong>Connection Failed</strong>

<strong>Error:</strong>
${error.message}

<strong>Troubleshooting:</strong>
1. Check that your Windmill webhook URL is correct
2. Verify "Webhook/Public API" is enabled in script settings
3. Make sure your OpenAI resource is configured in Windmill
4. Check browser console for CORS errors
5. Test the script directly in Windmill first

<strong>Common Issues:</strong>
‚Ä¢ CORS error ‚Üí Add this page's URL to allowed origins in Windmill
‚Ä¢ 404 error ‚Üí Check webhook URL is correct
‚Ä¢ 401/403 error ‚Üí Check OpenAI resource is configured
‚Ä¢ Network error ‚Üí Check internet connection
                `.trim();
            } finally {
                button.disabled = false;
            }
        }

        // Test on Enter key
        document.getElementById('testMessage').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && (e.metaKey || e.ctrlKey)) {
                testConnection();
            }
        });
    </script>
</body>
</html>
